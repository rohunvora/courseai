# CourseAI System Architecture

## High-Level System Flow

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│   FRONTEND      │◄──►│    BACKEND      │◄──►│   SUPABASE DB   │
│   (React)       │    │   (Fastify)     │    │   (PostgreSQL)  │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │                 │
                       │   OPENAI API    │
                       │   (GPT-4o)      │
                       │                 │
                       └─────────────────┘
```

## Detailed Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                           USER REQUEST                              │
│                     "I just benched 3x5 at 185"                    │
└─────────────────────┬───────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        FRONTEND LAYER                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │    Chat UI      │  │  Progress View  │  │   Settings      │     │
│  │  (Chat.tsx)     │  │    (Stats)      │  │   (Config)      │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
└─────────────────────┬───────────────────────────────────────────────┘
                      │ HTTP/WebSocket
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         API GATEWAY                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │   Rate Limit    │  │      CORS       │  │      Auth       │     │
│  │   Middleware    │  │   Middleware    │  │   Middleware    │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
└─────────────────────┬───────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      ROUTING LAYER                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │   /chat-tools   │  │    /actions     │  │   /sessions     │     │
│  │   (Main Chat)   │  │   (Logging)     │  │   (Auth)        │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
└─────────────────────┬───────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    INTELLIGENT CORE                                 │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                 A/B TESTING ENGINE                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │User Segment │  │   Variant   │  │Kill Switch │         │   │
│  │  │   Service   │  │  Selector   │  │  Monitor   │         │   │
│  │  │             │  │             │  │             │         │   │
│  │  │┌───────────┐│  │┌───────────┐│  │┌───────────┐│         │   │
│  │  ││beginner   ││  ││v7 (75%)   ││  ││Disable    ││         │   │
│  │  ││intermediate││  ││v3 (75%)   ││  ││Bad Vars   ││         │   │
│  │  ││advanced   ││  ││v5 (75%)   ││  ││Real-time  ││         │   │
│  │  │└───────────┘│  │└───────────┘│  │└───────────┘│         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│                              ▼                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   PROMPT ENGINE                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │   Prompt    │  │   Context   │  │   Safety    │         │   │
│  │  │ Selector    │  │  Builder    │  │   Rules     │         │   │
│  │  │             │  │             │  │             │         │   │
│  │  │┌───────────┐│  │┌───────────┐│  │┌───────────┐│         │   │
│  │  ││precision_ ││  ││Full Memory││  ││Stop Pain  ││         │   │
│  │  ││trainer    ││  ││PR History ││  ││10% Rule   ││         │   │
│  │  ││(Winner)   ││  ││Workouts   ││  ││Pro Help   ││         │   │
│  │  │└───────────┘│  │└───────────┘│  │└───────────┘│         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│                              ▼                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   MODEL LAYER                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │   Model     │  │OpenAI Tools │  │   Quality   │         │   │
│  │  │ Selector    │  │Integration  │  │  Monitor    │         │   │
│  │  │             │  │             │  │             │         │   │
│  │  │┌───────────┐│  │┌───────────┐│  │┌───────────┐│         │   │
│  │  ││GPT-4o     ││  ││log_workout││  ││Token Usage││         │   │
│  │  ││vs O3      ││  ││get_progress││││Latency    ││         │   │
│  │  ││Selection  ││  ││update_goal││  ││Error Rate ││         │   │
│  │  │└───────────┘│  │└───────────┘│  │└───────────┘│         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      DATA LAYER                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │   Workouts      │  │ Personal Records│  │    Memory       │     │
│  │   (sets/reps)   │  │   (PRs/Goals)   │  │   (Context)     │     │
│  │                 │  │                 │  │                 │     │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤     │
│  │ Users & Auth    │  │ Quality Metrics │  │ Action Logs     │     │
│  │ (Sessions)      │  │ (A/B Results)   │  │ (Audit Trail)   │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────┘
```

## Key Components Flow

### 1. **Request Processing**
```
User Input → Auth Check → Rate Limit → Route Handler
```

### 2. **Intelligent Processing** 
```
Segment User → Select Variant → Build Context → Generate Prompt → Call AI
```

### 3. **Response & Actions**
```
AI Response → Tool Calls → Database Updates → Quality Monitoring → User Response
```

## A/B Testing System

```
┌─────────────────────────────────────────────────────────────────────┐
│                        A/B Testing Flow                             │
│                                                                     │
│  User Request                                                       │
│       │                                                             │
│       ▼                                                             │
│  ┌─────────────────┐                                                │
│  │ User Segmentation│ ──┐                                           │
│  │ (Beginner/Inter/ │   │                                           │
│  │ Advanced/Return) │   │                                           │
│  └─────────────────┘   │                                           │
│                        │                                           │
│                        ▼                                           │
│               ┌─────────────────┐                                   │
│               │ Variant Selection│                                  │
│               │                 │                                  │
│               │ ┌─────────────┐ │     ┌─────────────────────────┐  │
│               │ │ v7: 75%     │ │────►│ Precision Trainer       │  │
│               │ │ v3: 75%     │ │     │ • Technical Focus       │  │
│               │ │ v5: 75%     │ │     │ • 1535ms Avg Response   │  │
│               │ │ v1: 50%     │ │     │ • 138 words             │  │
│               │ │ v6: 50%     │ │     │ • 100% Tool Accuracy    │  │
│               │ └─────────────┘ │     └─────────────────────────┘  │
│               └─────────────────┘                                   │
│                        │                                           │
│                        ▼                                           │
│               ┌─────────────────┐                                   │
│               │ Quality Gates   │                                  │
│               │ • >5% Error Rate│                                  │
│               │ • >3s Latency   │                                  │
│               │ • Safety Violations                               │
│               │ → Auto Disable  │                                  │
│               └─────────────────┘                                   │
└─────────────────────────────────────────────────────────────────────┘
```

## Safety & Monitoring

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Safety Pipeline                              │
│                                                                     │
│  Every AI Response                                                  │
│       │                                                             │
│       ▼                                                             │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐│
│  │ Safety Scanner  │────►│ Quality Monitor │────►│ Kill Switch     ││
│  │                 │     │                 │     │                 ││
│  │ • Pain Response │     │ • Tool Accuracy │     │ • Disable Bad   ││
│  │ • 10% Load Rule │     │ • Response Time │     │   Variants      ││
│  │ • Pro Referral  │     │ • Token Usage   │     │ • Alert Admins  ││
│  │ • Form Safety   │     │ • Error Rates   │     │ • Fallback Mode ││
│  └─────────────────┘     └─────────────────┘     └─────────────────┘│
│                                                                     │
│  Real-time Monitoring Dashboard:                                    │
│  • 100% Safety Compliance ✅                                        │
│  • Tool Call Accuracy: 100% ✅                                      │
│  • Avg Response Time: 1535ms ✅                                     │
│  • No Safety Violations ✅                                          │
└─────────────────────────────────────────────────────────────────────┘
```

This architecture ensures safety-first operation with intelligent variant selection and real-time quality monitoring.